import streamlit as st
import pandas as pd
import hashlib
from config.database import get_db_connection, init_db

def get_all_active_users():
    """Retorna todos os usu√°rios ativos"""
    try:
        conn = get_db_connection()
        users = pd.read_sql_query("""
            SELECT id, nome, email, tipo FROM usuarios 
            WHERE ativo = 1 
            ORDER BY nome
        """, conn)
        conn.close()
        return users
    except Exception as e:
        print(f"Erro ao buscar usu√°rios: {e}")
        return pd.DataFrame()  # Retorna DataFrame vazio se der erro

def authenticate_user(email, senha):
    """Autentica usu√°rio"""
    try:
        conn = get_db_connection()
        senha_hash = hashlib.sha256(senha.encode()).hexdigest()
        
        user = pd.read_sql_query("""
            SELECT id, nome, email, tipo FROM usuarios 
            WHERE email = ? AND senha = ? AND ativo = 1
        """, conn, params=[email, senha_hash])
        
        conn.close()
        
        if not user.empty:
            return user.iloc[0].to_dict()
        return None
    except Exception as e:
        print(f"Erro na autentica√ß√£o: {e}")
        return None

def show_login_page():
    """Exibe p√°gina de login"""
    st.title("üèóÔ∏è Sistema de Gest√£o de Obras")
    st.subheader("Controle Financeiro Profissional")
    
    # Verificar se as tabelas existem
    users = get_all_active_users()
    
    if users.empty:
        st.warning("‚ö†Ô∏è Banco de dados n√£o inicializado!")
        
        col1, col2 = st.columns([1, 1])
        
        with col1:
            if st.button("üîß Inicializar Banco de Dados", type="primary"):
                with st.spinner("Inicializando banco de dados..."):
                    try:
                        init_db()
                        st.success("‚úÖ Banco de dados inicializado com sucesso!")
                        st.info("üîÑ Recarregue a p√°gina para continuar")
                        st.rerun()
                    except Exception as e:
                        st.error(f"‚ùå Erro ao inicializar: {e}")
        
        with col2:
            st.info("üëÜ Clique no bot√£o para criar as tabelas do banco de dados")
        
        return
    
    # Se chegou aqui, o banco est√° OK
    _show_quick_login()

def _show_quick_login():
    """Exibe login r√°pido"""
    st.success("üöÄ Login r√°pido")
    
    users = get_all_active_users()
    
    if users.empty:
        st.warning("Nenhum usu√°rio encontrado. Cadastre o primeiro usu√°rio.")
        return
    
    # Criar op√ß√µes para selectbox
    user_options = {}
    for _, user in users.iterrows():
        label = f"{user['nome']} ({user['tipo'].title()})"
        user_options[label] = user
    
    selected_label = st.selectbox(
        "Selecione seu usu√°rio:",
        options=list(user_options.keys()),
        key="quick_login_user"
    )
    
    if selected_label and st.button("üöÄ Entrar", type="primary"):
        user = user_options[selected_label]
        st.session_state.user = user
        st.session_state.authenticated = True
        st.rerun()

def create_first_user():
    """Cria o primeiro usu√°rio do sistema"""
    try:
        conn = get_db_connection()
        cursor = conn.cursor()
        
        # Verificar se j√° existe usu√°rio
        cursor.execute("SELECT COUNT(*) FROM usuarios")
        count = cursor.fetchone()[0]
        
        if count == 0:
            # Criar usu√°rio padr√£o
            senha_hash = hashlib.sha256("123456".encode()).hexdigest()
            cursor.execute("""
                INSERT INTO usuarios (nome, email, senha, tipo) 
                VALUES (?, ?, ?, ?)
            """, ("Deverson", "deverson@obra.com", senha_hash, "gestor"))
            
            conn.commit()
            print("‚úÖ Usu√°rio padr√£o criado: deverson@obra.com / 123456")
        
        cursor.close()
        conn.close()
        
    except Exception as e:
        print(f"Erro ao criar usu√°rio padr√£o: {e}")

def logout():
    """Faz logout do usu√°rio"""
    for key in ['user', 'authenticated']:
        if key in st.session_state:
            del st.session_state[key]
    st.rerun()