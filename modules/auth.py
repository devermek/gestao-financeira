import sys
import streamlit as st
from datetime import datetime, date, timedelta
from config.database import get_connection, init_db

def authenticate_user(email, senha):
    """Autentica usu√°rio no sistema"""
    try:
        conn = get_connection()
        cursor = conn.cursor()
        
        import os
        is_postgres = os.getenv('DATABASE_URL') is not None
        
        if is_postgres:
            query = """
                SELECT id, nome, email, created_at
                FROM usuarios 
                WHERE email = %s AND senha = %s AND ativo = TRUE
            """
        else:
            query = """
                SELECT id, nome, email, created_at
                FROM usuarios 
                WHERE email = ? AND senha = ? AND ativo = 1
            """
        
        cursor.execute(query, (email, senha))
        user = cursor.fetchone()
        
        if user:
            # Log do login
            print(f"Login realizado: {user['email']} (ID: {user['id']})", file=sys.stderr)
            
            return {
                'id': user['id'],
                'nome': user['nome'],
                'email': user['email'],
                'created_at': user['created_at']
            }
        
        print(f"Tentativa de login falhada para: {email}", file=sys.stderr)
        return None
        
    except Exception as e:
        print(f"Erro na autentica√ß√£o: {repr(e)}", file=sys.stderr)
        return None
    finally:
        try:
            cursor.close()
            conn.close()
        except:
            pass

def create_user(nome, email, senha):
    """Cria novo usu√°rio"""
    try:
        conn = get_connection()
        cursor = conn.cursor()
        
        import os
        is_postgres = os.getenv('DATABASE_URL') is not None
        
        # Verifica se email j√° existe
        check_query = "SELECT id FROM usuarios WHERE email = %s" if is_postgres else "SELECT id FROM usuarios WHERE email = ?"
        cursor.execute(check_query, (email,))
        
        if cursor.fetchone():
            return False, "Email j√° cadastrado no sistema"
        
        # Cria usu√°rio
        if is_postgres:
            query = """
                INSERT INTO usuarios (nome, email, senha, ativo)
                VALUES (%s, %s, %s, TRUE)
                RETURNING id
            """
        else:
            query = """
                INSERT INTO usuarios (nome, email, senha, ativo)
                VALUES (?, ?, ?, 1)
            """
        
        cursor.execute(query, (nome, email, senha))
        
        if is_postgres:
            user_id = cursor.fetchone()[0]
        else:
            user_id = cursor.lastrowid
        
        conn.commit()
        
        print(f"Usu√°rio criado: {email} (ID: {user_id})", file=sys.stderr)
        return True, f"Usu√°rio criado com sucesso! ID: {user_id}"
        
    except Exception as e:
        print(f"Erro ao criar usu√°rio: {repr(e)}", file=sys.stderr)
        conn.rollback()
        return False, f"Erro ao criar usu√°rio: {str(e)}"
    finally:
        try:
            cursor.close()
            conn.close()
        except:
            pass

def create_first_user():
    """Cria primeiro usu√°rio e dados iniciais do sistema"""
    try:
        conn = get_connection()
        cursor = conn.cursor()
        
        import os
        is_postgres = os.getenv('DATABASE_URL') is not None
        
        # Verifica se j√° existe usu√°rio
        cursor.execute("SELECT COUNT(*) as count FROM usuarios")
        result = cursor.fetchone()
        user_count = result['count'] if result else 0
        
        if user_count > 0:
            st.info("Sistema j√° possui usu√°rios cadastrados.")
            return False
        
        print("Criando dados iniciais do sistema...", file=sys.stderr)
        
        # Cria usu√°rio padr√£o
        if is_postgres:
            cursor.execute("""
                INSERT INTO usuarios (nome, email, senha, ativo)
                VALUES (%s, %s, %s, TRUE)
            """, ("Deverson", "deverson@obra.com", "123456"))
        else:
            cursor.execute("""
                INSERT INTO usuarios (nome, email, senha, ativo)
                VALUES (?, ?, ?, 1)
            """, ("Deverson", "deverson@obra.com", "123456"))
        
        # Cria categorias padr√£o
        categorias_padrao = [
            ("Material de Constru√ß√£o", "Materiais b√°sicos como cimento, areia, brita", "#e74c3c"),
            ("M√£o de Obra", "Pagamentos de funcion√°rios e prestadores", "#3498db"),
            ("Ferramentas e Equipamentos", "Compra e aluguel de ferramentas", "#f39c12"),
            ("El√©trica", "Material e servi√ßos el√©tricos", "#9b59b6"),
            ("Hidr√°ulica", "Material e servi√ßos hidr√°ulicos", "#1abc9c"),
            ("Acabamento", "Materiais de acabamento e pintura", "#34495e"),
            ("Documenta√ß√£o", "Taxas, licen√ßas e documentos", "#95a5a6"),
            ("Transporte", "Fretes e transportes diversos", "#e67e22"),
            ("Alimenta√ß√£o", "Alimenta√ß√£o da equipe", "#27ae60"),
            ("Outros", "Gastos diversos n√£o categorizados", "#7f8c8d")
        ]
        
        for nome, descricao, cor in categorias_padrao:
            if is_postgres:
                cursor.execute("""
                    INSERT INTO categorias (nome, descricao, cor, ativo)
                    VALUES (%s, %s, %s, TRUE)
                """, (nome, descricao, cor))
            else:
                cursor.execute("""
                    INSERT INTO categorias (nome, descricao, cor, ativo)
                    VALUES (?, ?, ?, 1)
                """, (nome, descricao, cor))
        
        # Cria obra padr√£o
        data_inicio = date.today()
        data_fim = data_inicio + timedelta(days=365)  # 1 ano de dura√ß√£o
        
        if is_postgres:
            cursor.execute("""
                INSERT INTO obras (nome, orcamento, data_inicio, data_fim_prevista, ativo)
                VALUES (%s, %s, %s, %s, TRUE)
            """, ("Minha Obra", 100000.00, data_inicio, data_fim))
        else:
            cursor.execute("""
                INSERT INTO obras (nome, orcamento, data_inicio, data_fim_prevista, ativo)
                VALUES (?, ?, ?, ?, 1)
            """, ("Minha Obra", 100000.00, data_inicio, data_fim))
        
        conn.commit()
        
        print("Dados iniciais criados com sucesso!", file=sys.stderr)
        
        st.success("‚úÖ Sistema inicializado com sucesso!")
        st.info("""
        **Dados criados:**
        - üë§ Usu√°rio: deverson@obra.com / 123456
        - ÔøΩÔøΩÔ∏è 10 categorias padr√£o
        - ÔøΩÔøΩÔ∏è Obra inicial com or√ßamento de R\$ 100.000,00
        
        **Agora voc√™ pode fazer login!**
        """)
        
        return True
        
    except Exception as e:
        print(f"Erro ao criar primeiro usu√°rio: {repr(e)}", file=sys.stderr)
        conn.rollback()
        st.error(f"Erro ao inicializar sistema: {str(e)}")
        return False
    finally:
        try:
            cursor.close()
            conn.close()
        except:
            pass

def update_user_password(user_id, nova_senha):
    """Atualiza senha do usu√°rio"""
    try:
        conn = get_connection()
        cursor = conn.cursor()
        
        import os
        is_postgres = os.getenv('DATABASE_URL') is not None
        
        if is_postgres:
            query = """
                UPDATE usuarios 
                SET senha = %s, updated_at = CURRENT_TIMESTAMP
                WHERE id = %s
            """
        else:
            query = """
                UPDATE usuarios 
                SET senha = ?, updated_at = CURRENT_TIMESTAMP
                WHERE id = ?
            """
        
        cursor.execute(query, (nova_senha, user_id))
        conn.commit()
        
        if cursor.rowcount > 0:
            print(f"Senha atualizada para usu√°rio ID: {user_id}", file=sys.stderr)
            return True
        else:
            print(f"Usu√°rio n√£o encontrado: {user_id}", file=sys.stderr)
            return False
        
    except Exception as e:
        print(f"Erro ao atualizar senha: {repr(e)}", file=sys.stderr)
        conn.rollback()
        return False
    finally:
        try:
            cursor.close()
            conn.close()
        except:
            pass

def get_user_by_id(user_id):
    """Busca usu√°rio por ID"""
    try:
        conn = get_connection()
        cursor = conn.cursor()
        
        import os
        is_postgres = os.getenv('DATABASE_URL') is not None
        
        query = """
            SELECT id, nome, email, ativo, created_at, updated_at
            FROM usuarios
            WHERE id = %s
        """ if is_postgres else """
            SELECT id, nome, email, ativo, created_at, updated_at
            FROM usuarios
            WHERE id = ?
        """
        
        cursor.execute(query, (user_id,))
        user = cursor.fetchone()
        
        if user:
            return {
                'id': user['id'],
                'nome': user['nome'],
                'email': user['email'],
                'ativo': bool(user['ativo']),
                'created_at': user['created_at'],
                'updated_at': user['updated_at']
            }
        
        return None
        
    except Exception as e:
        print(f"Erro ao buscar usu√°rio: {repr(e)}", file=sys.stderr)
        return None
    finally:
        try:
            cursor.close()
            conn.close()
        except:
            pass

def show_login_page():
    """Exibe p√°gina de login"""
    st.markdown("""
    <div style="text-align: center; padding: 2rem 0;">
        <h1>üèóÔ∏è Sistema de Gest√£o Financeira</h1>
        <h3>Controle Financeiro para Obras</h3>
        <p style="color: #888; margin-top: 1rem;">
            Gerencie todos os gastos da sua obra de forma organizada e eficiente
        </p>
    </div>
    """, unsafe_allow_html=True)
    
    # Container centralizado para login
    col1, col2, col3 = st.columns([1, 2, 1])
    
    with col2:
        with st.container():
            st.markdown("""
            <div class="card-container">
            """, unsafe_allow_html=True)
            
            st.subheader("üîê Acesso ao Sistema")
            
            # Tabs para Login e Cadastro
            tab1, tab2 = st.tabs(["üö™ Login", "üë§ Cadastro"])
            
            with tab1:
                _show_login_form()
            
            with tab2:
                _show_register_form()
            
            st.markdown("</div>", unsafe_allow_html=True)
    
    # Informa√ß√µes do sistema
    st.markdown("---")
    
    col_info1, col_info2, col_info3 = st.columns(3)
    
    with col_info1:
        st.markdown("""
        ### üìã Funcionalidades
        - üìä Dashboard com m√©tricas
        - üí∞ Controle de lan√ßamentos
        - üìé Upload de comprovantes
        - üìà Relat√≥rios detalhados
        - ‚öôÔ∏è Configura√ß√µes flex√≠veis
        """)
    
    with col_info2:
        st.markdown("""
        ### üîß Primeiro Acesso
        1. Clique em "Inicializar Sistema"
        2. Aguarde a cria√ß√£o das tabelas
        3. Use: deverson@obra.com / 123456
        4. Configure sua obra nas Configura√ß√µes
        """)
    
    with col_info3:
        st.markdown("""
        ### üõ°Ô∏è Seguran√ßa
        - ‚úÖ Dados protegidos
        - ‚úÖ Backup autom√°tico
        - ‚úÖ Acesso controlado
        - ‚úÖ Logs de auditoria
        """)

def _show_login_form():
    """Formul√°rio de login"""
    with st.form("login_form"):
        email = st.text_input("üìß Email", placeholder="seu@email.com")
        senha = st.text_input("üîí Senha", type="password", placeholder="Sua senha")
        
        col_login, col_init = st.columns(2)
        
        with col_login:
            login_button = st.form_submit_button("üöÄ Entrar", use_container_width=True)
        
        with col_init:
            init_button = st.form_submit_button("üîß Inicializar Sistema", use_container_width=True)
    
    # Bot√£o de login r√°pido para desenvolvimento
    if st.button("‚ö° Login R√°pido (Dev)", use_container_width=True, help="Login autom√°tico para desenvolvimento"):
        user = authenticate_user("deverson@obra.com", "123456")
        if user:
            st.session_state.authenticated = True
            st.session_state.user = user
            st.success("Login realizado com sucesso!")
            st.rerun()
        else:
            st.error("Usu√°rio padr√£o n√£o encontrado. Inicialize o sistema primeiro.")
    
    # Processa login
    if login_button:
        if not email or not senha:
            st.error("‚ö†Ô∏è Por favor, preencha email e senha.")
        else:
            with st.spinner("Autenticando..."):
                user = authenticate_user(email, senha)
                if user:
                    st.session_state.authenticated = True
                    st.session_state.user = user
                    st.success(f"‚úÖ Bem-vindo, {user['nome']}!")
                    st.rerun()
                else:
                    st.error("‚ùå Email ou senha incorretos.")
    
    # Processa inicializa√ß√£o
    if init_button:
        with st.spinner("Inicializando banco de dados..."):
            try:
                # Primeiro inicializa as tabelas
                init_db()
                st.success("‚úÖ Tabelas criadas com sucesso!")
                
                # Depois cria os dados iniciais
                if create_first_user():
                    st.balloons()
                
            except Exception as e:
                st.error(f"‚ùå Erro na inicializa√ß√£o: {str(e)}")
                print(f"Erro na inicializa√ß√£o: {repr(e)}", file=sys.stderr)

def _show_register_form():
    """Formul√°rio de cadastro"""
    st.info("üí° Cadastro de novos usu√°rios dispon√≠vel ap√≥s login do administrador")
    
    with st.form("register_form"):
        nome = st.text_input("üë§ Nome Completo", placeholder="Seu nome completo")
        email = st.text_input("üìß Email", placeholder="seu@email.com")
        senha = st.text_input("üîí Senha", type="password", placeholder="M√≠nimo 6 caracteres")
        confirma_senha = st.text_input("üîí Confirmar Senha", type="password", placeholder="Repita a senha")
        
        register_button = st.form_submit_button("üë§ Criar Conta", use_container_width=True)
    
    if register_button:
        # Valida√ß√µes
        if not all([nome, email, senha, confirma_senha]):
            st.error("‚ö†Ô∏è Todos os campos s√£o obrigat√≥rios.")
        elif len(senha) < 6:
            st.error("‚ö†Ô∏è A senha deve ter pelo menos 6 caracteres.")
        elif senha != confirma_senha:
            st.error("‚ö†Ô∏è As senhas n√£o coincidem.")
        elif "@" not in email or "." not in email:
            st.error("‚ö†Ô∏è Email inv√°lido.")
        else:
            with st.spinner("Criando conta..."):
                success, message = create_user(nome, email, senha)
                if success:
                    st.success(f"‚úÖ {message}")
                    st.info("Agora voc√™ pode fazer login!")
                else:
                    st.error(f"‚ùå {message}")

def logout():
    """Realiza logout do usu√°rio"""
    user = st.session_state.get('user')
    if user:
        print(f"Logout realizado: {user['email']}", file=sys.stderr)
    
    # Limpa dados da sess√£o
    keys_to_clear = ['authenticated', 'user', 'current_page']
    for key in keys_to_clear:
        if key in st.session_state:
            del st.session_state[key]
    
    st.rerun()

def check_authentication():
    """Verifica se usu√°rio est√° autenticado"""
    return st.session_state.get('authenticated', False)

def get_current_user():
    """Retorna dados do usu√°rio atual"""
    return st.session_state.get('user', None)

def show_user_header():
    """Exibe cabe√ßalho com informa√ß√µes do usu√°rio"""
    user = get_current_user()
    if user:
        col1, col2, col3 = st.columns([2, 1, 1])
        
        with col1:
            st.markdown(f"### ÔøΩÔøΩ Ol√°, **{user['nome']}**!")
            st.caption(f"üìß {user['email']}")
        
        with col2:
            # Bot√£o de configura√ß√µes do usu√°rio
            if st.button("‚öôÔ∏è Perfil", use_container_width=True):
                st.session_state['show_user_config'] = True
        
        with col3:
            if st.button("üö™ Sair", use_container_width=True):
                logout()
        
        # Modal de configura√ß√µes do usu√°rio
        if st.session_state.get('show_user_config', False):
            _show_user_config_modal()

def _show_user_config_modal():
    """Modal para configura√ß√µes do usu√°rio"""
    with st.expander("üë§ Configura√ß√µes do Usu√°rio", expanded=True):
        user = get_current_user()
        
        st.subheader("üîí Alterar Senha")
        
        with st.form("change_password_form"):
            nova_senha = st.text_input("Nova Senha", type="password", placeholder="M√≠nimo 6 caracteres")
            confirma_nova_senha = st.text_input("Confirmar Nova Senha", type="password")
            
            col1, col2 = st.columns(2)
            
            with col1:
                if st.form_submit_button("üíæ Alterar Senha", use_container_width=True):
                    if not nova_senha or not confirma_nova_senha:
                        st.error("‚ö†Ô∏è Preencha todos os campos.")
                    elif len(nova_senha) < 6:
                        st.error("‚ö†Ô∏è A senha deve ter pelo menos 6 caracteres.")
                    elif nova_senha != confirma_nova_senha:
                        st.error("‚ö†Ô∏è As senhas n√£o coincidem.")
                    else:
                        if update_user_password(user['id'], nova_senha):
                            st.success("‚úÖ Senha alterada com sucesso!")
                            st.session_state['show_user_config'] = False
                            st.rerun()
                        else:
                            st.error("‚ùå Erro ao alterar senha.")
            
            with col2:
                if st.form_submit_button("‚ùå Cancelar", use_container_width=True):
                    st.session_state['show_user_config'] = False
                    st.rerun()

def require_auth(func):
    """Decorator para p√°ginas que requerem autentica√ß√£o"""
    def wrapper(*args, **kwargs):
        if not check_authentication():
            show_login_page()
            return
        return func(*args, **kwargs)
    return wrapper

def get_user_stats():
    """Retorna estat√≠sticas do usu√°rio atual"""
    try:
        user = get_current_user()
        if not user:
            return None
        
        conn = get_connection()
        cursor = conn.cursor()
        
        import os
        is_postgres = os.getenv('DATABASE_URL') is not None
        
        # Estat√≠sticas b√°sicas
        stats = {
            'total_lancamentos': 0,
            'valor_total': 0.0,
            'ultimo_acesso': user.get('created_at'),
            'dias_no_sistema': 0
        }
        
        # Total de lan√ßamentos do usu√°rio (assumindo que h√° rela√ß√£o com obras)
        query = """
            SELECT COUNT(*) as total, COALESCE(SUM(valor), 0) as soma
            FROM lancamentos l
            JOIN obras o ON l.obra_id = o.id
            WHERE o.ativo = %s
        """ if is_postgres else """
            SELECT COUNT(*) as total, COALESCE(SUM(valor), 0) as soma
            FROM lancamentos l
            JOIN obras o ON l.obra_id = o.id
            WHERE o.ativo = ?
        """
        
        cursor.execute(query, (True if is_postgres else 1,))
        result = cursor.fetchone()
        
        if result:
            stats['total_lancamentos'] = result['total']
            
            # Converte valor
            try:
                if result['soma'] is not None:
                    from decimal import Decimal
                    if isinstance(result['soma'], Decimal):
                        stats['valor_total'] = float(result['soma'])
                    else:
                        stats['valor_total'] = float(result['soma'])
            except (TypeError, ValueError):
                stats['valor_total'] = 0.0
        
        # Calcula dias no sistema
        if user.get('created_at'):
            try:
                if isinstance(user['created_at'], str):
                    created_date = datetime.strptime(user['created_at'][:10], '%Y-%m-%d').date()
                else:
                    created_date = user['created_at'].date() if hasattr(user['created_at'], 'date') else user['created_at']
                
                stats['dias_no_sistema'] = (date.today() - created_date).days
            except:
                stats['dias_no_sistema'] = 0
        
        cursor.close()
        conn.close()
        
        return stats
        
    except Exception as e:
        print(f"Erro ao obter estat√≠sticas do usu√°rio: {repr(e)}", file=sys.stderr)
        return None

# Fun√ß√£o para verificar se √© primeiro acesso
def is_first_access():
    """Verifica se √© o primeiro acesso ao sistema"""
    try:
        conn = get_connection()
        cursor = conn.cursor()
        
        cursor.execute("SELECT COUNT(*) as count FROM usuarios")
        result = cursor.fetchone()
        user_count = result['count'] if result else 0
        
        cursor.close()
        conn.close()
        
        return user_count == 0
        
    except Exception as e:
        print(f"Erro ao verificar primeiro acesso: {repr(e)}", file=sys.stderr)
        return True  # Assume primeiro acesso em caso de erro